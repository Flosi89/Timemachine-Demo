<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Zeitreise Luzern</title>
  <style>
    body, html { margin:0; padding:0; height:100%; overflow:hidden; background:#000; font-family: system-ui, sans-serif; }
    #video { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; z-index:0; }
    #overlay {
      position:absolute; inset:0; width:100%; height:100%; object-fit:cover;
      transform-origin:center center; will-change:transform, opacity; z-index:5; display:none;
    }
    #ui { position:absolute; left:0; right:0; bottom:0; padding:12px; display:grid; gap:10px;
          background:linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.55) 40%, rgba(0,0,0,.75) 100%); z-index:10; }
    input[type=range] { width:100%; }
    #status { position:absolute; top:10px; left:10px; right:10px; color:#fff; background:rgba(0,0,0,.7); padding:8px 10px; border-radius:10px; font-size:14px; z-index:11; white-space:pre-wrap; }
    #reload { position:absolute; top:10px; right:10px; z-index:12; padding:10px 12px; border-radius:10px; border:none; background:#1976d2; color:#fff; font-weight:700; }
    #infobox { position:absolute; left:10px; right:10px; bottom:90px; background:rgba(0,0,0,.75); color:#fff; padding:12px; border-radius:12px; z-index:20; display:none; }
    #audio-btn { margin-top:8px; padding:8px 12px; border:none; border-radius:8px; background:#1976d2; color:#fff; font-weight:600; }
    /* Startscreen */
    #startscreen {
      position:fixed; inset:0; background:#0b0b0b; color:#fff;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      text-align:center; z-index:999;
      padding: 24px;
      background: radial-gradient(ellipse at top, #1a1a1a, #0b0b0b);
    }
    #startscreen h1 { margin: 0 0 8px 0; }
    #startscreen p { opacity:.9; }
    #startbtn {
      margin-top:18px; padding:12px 24px; border:none; border-radius:12px;
      background:#1976d2; color:#fff; font-size:18px; font-weight:700;
    }
  </style>
</head>
<body>
  <!-- Startscreen -->
  <div id="startscreen">
    <h1>üåç Zeitreise Luzern</h1>
    <p>Erlebe Orte im Tribschenquartier, wie sie fr√ºher aussahen.<br>Tippe auf Start und erlaube Kamera & Standort.</p>
    <button id="startbtn">Start</button>
  </div>

  <div id="status" style="display:none;">‚è≥ Lade Orte‚Ä¶</div>
  <button id="reload" style="display:none;">Neu pr√ºfen</button>
  <video id="video" autoplay playsinline webkit-playsinline muted></video>
  <img id="overlay" src="">
  <div id="ui" style="display:none;">
    <input type="range" min="0" max="100" value="70" id="opacity">
  </div>

  <div id="infobox">
    <div id="info-title" style="font-weight:700;margin-bottom:6px;"></div>
    <div id="info-text" style="font-size:14px;opacity:.95;"></div>
    <button id="audio-btn">‚ñ∂Ô∏è Audio abspielen</button>
    <audio id="audio-player"></audio>
  </div>

  <script>
    const overlay = document.getElementById('overlay');
    const statusBox = document.getElementById('status');
    const reloadBtn = document.getElementById('reload');
    const ui = document.getElementById('ui');
    const startscreen = document.getElementById('startscreen');
    const startbtn = document.getElementById('startbtn');
    const infoBox = document.getElementById('infobox');
    const infoTitle = document.getElementById('info-title');
    const infoText = document.getElementById('info-text');
    const audioBtn = document.getElementById('audio-btn');
    const audioPlayer = document.getElementById('audio-player');
    const RADIUS_KM = 0.5;

    function log(msg){ statusBox.textContent += '\n' + msg; }

    // Kamera
    async function startCam(){
      try{
        const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:{exact:'environment'}},audio:false});
        video.srcObject=s; await video.play().catch(()=>{});
      }catch(e1){
        try{
          const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
          video.srcObject=s; await video.play().catch(()=>{});
        }catch(e2){
          const s=await navigator.mediaDevices.getUserMedia({video:true,audio:false});
          video.srcObject=s; await video.play().catch(()=>{});
        }
      }
    }

    // Orte
    let ORTE = [];
    async function loadOrte(){
      statusBox.textContent = '‚è≥ Lade Orte‚Ä¶';
      try{
        const r = await fetch('orte.json?v=' + Date.now());
        ORTE = await r.json();
        log('‚úÖ Orte geladen: ' + ORTE.length);
      }catch(err){
        log('‚ùå Orte-Fehler: ' + err.message);
      }
    }

    function distKm(lat1,lng1,lat2,lng2){
      const R=6371;
      const dLat=(lat2-lat1)*Math.PI/180;
      const dLon=(lng2-lng1)*Math.PI/180;
      const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
      return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }
    function findNearest(lat,lng){
      let best=null, bestDist=Infinity;
      for(const o of ORTE){
        const d=distKm(lat,lng,o.lat,o.lng);
        if(d<bestDist){ bestDist=d; best=o; }
      }
      return {best, distanceKm: bestDist};
    }

    function showImage(src){
      overlay.onload = ()=>{ log('üñºÔ∏è Bild geladen: '+src); overlay.style.display='block'; };
      overlay.onerror = ()=>{ log('‚ùå Bild konnte nicht geladen werden: '+src); };
      overlay.src = src + (src.includes('?')?'&':'?') + 'v=' + Date.now();
    }

    function showInfo(ort){
      if(!ort) { infoBox.style.display='none'; return; }
      infoTitle.textContent = ort.name || '';
      infoText.textContent = ort.info || '';
      if(ort.audio){
        audioPlayer.src = ort.audio + (ort.audio.includes('?')?'&':'?') + 'v=' + Date.now();
        audioBtn.style.display = 'inline-block';
        audioBtn.textContent = '‚ñ∂Ô∏è Audio abspielen';
        audioBtn.onclick = () => {
          if(audioPlayer.paused){ audioPlayer.play(); audioBtn.textContent = '‚è∏Ô∏è Audio pausieren'; }
          else { audioPlayer.pause(); audioBtn.textContent = '‚ñ∂Ô∏è Audio abspielen'; }
        };
      } else {
        audioBtn.style.display = 'none';
      }
      infoBox.style.display = (ort.info || ort.audio) ? 'block' : 'none';
    }

    async function checkGPS(){
      if(ORTE.length===0){ await loadOrte(); }
      if(!navigator.geolocation){ log('‚ùå GPS nicht unterst√ºtzt'); return; }
      statusBox.textContent = '‚è≥ Standort wird ermittelt‚Ä¶';
      navigator.geolocation.getCurrentPosition(pos=>{
        const {latitude,longitude}=pos.coords;
        log('üìç ' + latitude.toFixed(5) + ', ' + longitude.toFixed(5));
        const {best, distanceKm} = findNearest(latitude,longitude);
        if(best){
          log('N√§chster Ort: ' + best.name + ' (' + distanceKm.toFixed(2) + ' km)');
          if(distanceKm < RADIUS_KM){
            showImage(best.image);
            showInfo(best);
          } else {
            overlay.style.display='none';
            showInfo(null);
            log('üö´ Kein Ort im Radius ' + RADIUS_KM + ' km');
          }
        } else {
          showInfo(null);
          log('‚ö†Ô∏è Keine Orte in Liste gefunden');
        }
      }, err=>{
        showInfo(null);
        log('‚ùå Standort-Fehler: ' + err.message);
      }, { enableHighAccuracy:true, timeout:10000, maximumAge:0 });
    }

    // Opacity slider
    document.getElementById('opacity').addEventListener('input', e=>{
      overlay.style.opacity = e.target.value/100;
    });

    // Gestensteuerung
    overlay.style.touchAction = "none";
    let state = { x:0, y:0, scale:1, rot:0 };
    function apply(){ overlay.style.transform = `translate(${state.x}px, ${state.y}px) scale(${state.scale}) rotate(${state.rot}deg)`; }

    let dragging = false, last = {x:0,y:0};
    overlay.addEventListener('pointerdown', e=>{
      if (e.target.closest('#ui')) return;
      dragging = true; last = {x:e.clientX, y:e.clientY}; overlay.setPointerCapture(e.pointerId);
    });
    overlay.addEventListener('pointermove', e=>{
      if(!dragging) return;
      const dx = e.clientX - last.x; const dy = e.clientY - last.y;
      state.x += dx; state.y += dy; last = {x:e.clientX, y:e.clientY}; apply();
    });
    overlay.addEventListener('pointerup', ()=> dragging=false);
    overlay.addEventListener('pointercancel', ()=> dragging=false);

    let twoStart = null;
    function tdist(a,b){ return Math.hypot(a.clientX-b.clientX, a.clientY-b.clientY); }
    function tangle(a,b){ return Math.atan2(b.clientY-a.clientY, b.clientX-a.clientX) * 180/Math.PI; }
    function tcenter(a,b){ return { x:(a.clientX+b.clientX)/2, y:(a.clientY+b.clientY)/2 }; }

    overlay.addEventListener('touchstart', (e)=>{
      if (e.target.closest('#ui')) return;
      if(e.touches.length===2){
        const [t1,t2]=[e.touches[0], e.touches[1]];
        twoStart = { dist: tdist(t1,t2), angle: tangle(t1,t2), center: tcenter(t1,t2),
                     baseScale: state.scale, baseRot: state.rot, baseX: state.x, baseY: state.y };
      }
    }, {passive:false});

    overlay.addEventListener('touchmove', (e)=>{
      if (e.target.closest('#ui')) return;
      if(e.touches.length===2 && twoStart){
        e.preventDefault();
        const [t1,t2]=[e.touches[0], e.touches[1]];
        const scaleFactor = tdist(t1,t2)/Math.max(1,twoStart.dist);
        const rotDelta = tangle(t1,t2) - twoStart.angle;
        state.scale = Math.max(0.2, Math.min(5, twoStart.baseScale * scaleFactor));
        state.rot = twoStart.baseRot + rotDelta;
        const c = tcenter(t1,t2);
        state.x = twoStart.baseX + (c.x - twoStart.center.x);
        state.y = twoStart.baseY + (c.y - twoStart.center.y);
        apply();
      }
    }, {passive:false});

    overlay.addEventListener('touchend', ()=>{ twoStart=null; });
    overlay.addEventListener('touchcancel', ()=>{ twoStart=null; });

    // Startbutton
    startbtn.addEventListener('click', async ()=>{
      startscreen.style.display = 'none';
      statusBox.style.display = 'block';
      reloadBtn.style.display = 'inline-block';
      ui.style.display = 'grid';
      await startCam();
      await loadOrte();
      await checkGPS();
    });

    reloadBtn.addEventListener('click', checkGPS);
  </script>
</body>
</html>
