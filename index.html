<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Fr√ºher/Heute Ansicht (GPS + Radius)</title>
  <style>
    body, html { margin:0; padding:0; height:100%; overflow:hidden; background:#000; font-family: system-ui, sans-serif; }
    #video, #overlay {
      position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover;
    }
    #overlay { transform-origin: center center; will-change: opacity; display:none; }
    #ui { position:absolute; left:0; right:0; bottom:0; padding:12px; display:grid; gap:10px; background:linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.55) 40%, rgba(0,0,0,.75) 100%); z-index:10; }
    input[type=range] { width:100%; }
    #status { position:absolute; top:10px; left:10px; right:10px; color:#fff; background:rgba(0,0,0,.6); padding:8px 10px; border-radius:10px; font-size:14px; z-index:11; }
  </style>
</head>
<body>
  <div id="status">‚è≥ Standort wird ermittelt‚Ä¶</div>
  <video id="video" autoplay playsinline webkit-playsinline muted></video>
  <img id="overlay" src="" style="opacity:0.6">
  <div id="ui">
    <input type="range" min="0" max="100" value="60" id="opacity">
  </div>

  <script>
    const overlay = document.getElementById('overlay');
    const statusBox = document.getElementById('status');
    const RADIUS_KM = 0.2; // <-- Reichweite in km (z.B. 0.2 = 200 Meter)

    // Kamera starten
    (async function startCam(){
      try{
        const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:{exact:'environment'}},audio:false});
        video.srcObject=s; await video.play().catch(()=>{});
      }catch(e1){
        try{
          const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
          video.srcObject=s; await video.play().catch(()=>{});
        }catch(e2){
          const s=await navigator.mediaDevices.getUserMedia({video:true,audio:false});
          video.srcObject=s; await video.play().catch(()=>{});
        }
      }
    })();

    // Orte laden
    let orte = [];
    fetch('orte.json').then(r=>r.json()).then(data=>{ orte = data; });

    function distKm(lat1,lng1,lat2,lng2){
      const R=6371; // km
      const dLat=(lat2-lat1)*Math.PI/180;
      const dLon=(lng2-lng1)*Math.PI/180;
      const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
      return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }

    function findNearest(lat,lng){
      let best=null, bestDist=Infinity;
      for(const o of orte){
        const d=distKm(lat,lng,o.lat,o.lng);
        if(d<bestDist){ bestDist=d; best=o; }
      }
      return {best, distanceKm: bestDist};
    }

    // GPS holen
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(pos=>{
        const {latitude,longitude}=pos.coords;
        const {best, distanceKm} = findNearest(latitude,longitude);
        statusBox.textContent='üìç '+latitude.toFixed(5)+', '+longitude.toFixed(5)+' | N√§chster Ort: '+(best?best.name:'‚Äî')+' ('+distanceKm.toFixed(2)+' km)';
        if(best && distanceKm < RADIUS_KM){
          overlay.src = best.image + '?v=' + Date.now(); // Cache-Busting
          overlay.style.display='block';
        } else {
          overlay.style.display='none';
          statusBox.textContent += ' ‚Üí Kein Ort in Reichweite (Radius '+RADIUS_KM+' km)';
        }
      }, err=>{
        statusBox.textContent='‚ùå Standort-Fehler: '+err.message;
      }, { enableHighAccuracy:true, timeout:10000, maximumAge:0 });
    } else {
      statusBox.textContent='‚ùå GPS nicht unterst√ºtzt';
    }

    // Opacity slider
    document.getElementById('opacity').addEventListener('input', e=>{
      overlay.style.opacity = e.target.value/100;
    });
  </script>
</body>
</html>
