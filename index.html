<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Zeitreise Luzern v10f (UI)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    :root{
      --bg: rgba(16,16,16,.75);
      --panel: rgba(0,0,0,.82);
      --brand: #1976d2;
      --text: #fff;
      --radius: 12px;
      --gap: 10px;
      --safe: env(safe-area-inset-bottom, 0px);
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:#000;font-family:system-ui,-apple-system,Roboto,Arial,sans-serif}
    /* Kamera + Overlay-Bild */
    #camera{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:#000;z-index:0}
    #imageOverlay{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:none;opacity:.7;transform-origin:center center;will-change:transform,opacity;z-index:5}
    /* Header-Bar */
    #header{position:absolute;top:0;left:0;right:0;padding:10px;display:flex;gap:8px;align-items:center;background:linear-gradient(180deg, rgba(0,0,0,.9), rgba(0,0,0,.35), transparent);z-index:20}
    #placeSelect{flex:1;min-width:0;height:40px;border:1px solid rgba(255,255,255,.15);border-radius:10px;background:#ffffff;color:#111;padding:0 10px;font-weight:600}
    .btn{padding:0 12px;height:40px;border:none;border-radius:10px;background:var(--brand);color:#fff;font-weight:700}
    .btn.secondary{background:#393a3d;color:#fff}
    /* Toast unten links */
    #toast{position:absolute;left:10px;bottom:calc(80px + var(--safe));max-width:75vw;background:var(--bg);color:var(--text);padding:10px 12px;border-radius:10px;font-size:13px;z-index:25;display:none;white-space:pre-wrap}
    /* Infobox unten */
    #infobox{position:absolute;left:10px;right:10px;bottom:calc(60px + var(--safe));background:var(--panel);color:#fff;padding:12px;border-radius:var(--radius);z-index:15;display:none}
    #audio-btn{margin-top:8px;padding:10px 12px;border:none;border-radius:10px;background:var(--brand);color:#fff;font-weight:700}
    /* Footer (Slider) */
    #footer{position:absolute;left:0;right:0;bottom:0;padding:0 14px calc(10px + var(--safe));z-index:14;display:none}
    #opacity{width:100%}
    /* Kartenlayer */
    #mapWrap{position:absolute;inset:0;display:none;z-index:18}
    #map{position:absolute;inset:0}
    /* Startscreen */
    #startscreen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#0b0b0b;color:#fff;z-index:999;text-align:center;padding:24px}
    #startbtn{padding:12px 20px;border:none;border-radius:12px;background:var(--brand);color:#fff;font-size:18px;font-weight:800}
  </style>
</head>
<body>
  <!-- Start -->
  <div id="startscreen">
    <div>
      <h2>üåç Zeitreise Luzern</h2>
      <p style="opacity:.9">Tippe auf Start und erlaube Kamera & Standort.</p>
      <button id="startbtn">Start</button>
      <div style="opacity:.7;margin-top:10px;font-size:13px;">Tipp: Im Schloss-Symbol Kamera/Standort zulassen.</div>
    </div>
  </div>

  <!-- Header -->
  <div id="header" style="display:none;">
    <select id="placeSelect"><option value="">Ort w√§hlen‚Ä¶</option></select>
    <button id="toggleMap" class="btn secondary" title="Karte / Kamera umschalten">üó∫Ô∏è Karte</button>
    <button id="backToGPS" class="btn" style="display:none">GPS</button>
  </div>

  <!-- Streams -->
  <video id="camera" autoplay playsinline webkit-playsinline muted></video>
  <img id="imageOverlay" alt="Historisches Overlay">

  <!-- Karte -->
  <div id="mapWrap"><div id="map"></div></div>

  <!-- Infobox -->
  <div id="infobox">
    <div id="info-title" style="font-weight:800;font-size:18px;margin-bottom:6px;"></div>
    <div id="info-text" style="font-size:14px;opacity:.95;"></div>
    <button id="audio-btn">‚ñ∂Ô∏è Audio abspielen</button>
    <audio id="audio-player"></audio>
  </div>

  <!-- Footer Controls -->
  <div id="footer">
    <input id="opacity" type="range" min="0" max="100" value="70">
  </div>

  <!-- Toast -->
  <div id="toast"></div>

  <link rel="preconnect" href="https://unpkg.com">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // DOM
    const camera = document.getElementById('camera');
    const imageOverlay = document.getElementById('imageOverlay');
    const startscreen = document.getElementById('startscreen');
    const startbtn = document.getElementById('startbtn');
    const header = document.getElementById('header');
    const footer = document.getElementById('footer');
    const placeSelect = document.getElementById('placeSelect');
    const backToGPS = document.getElementById('backToGPS');
    const toggleMapBtn = document.getElementById('toggleMap');
    const infobox = document.getElementById('infobox');
    const infoTitle = document.getElementById('info-title');
    const infoText = document.getElementById('info-text');
    const audioBtn = document.getElementById('audio-btn');
    const audioPlayer = document.getElementById('audio-player');
    const opacity = document.getElementById('opacity');
    const mapWrap = document.getElementById('mapWrap');
    const toast = document.getElementById('toast');

    // State
    let places = [];
    let manualMode = false;
    let map=null, mapVisible=false;

    // Toast helper
    let toastTimer=null;
    function log(msg){
      toast.style.display='block';
      toast.textContent = msg;
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>{ toast.style.display='none'; }, 4000);
    }

    async function startCamera(){
      try{
        const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:{exact:'environment'}},audio:false});
        camera.srcObject=s; await camera.play().catch(()=>{}); log('üé• Kamera aktiv');
      }catch{
        try{
          const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
          camera.srcObject=s; await camera.play().catch(()=>{}); log('üé• Kamera aktiv (Fallback)');
        }catch(e){
          log('‚ùå Kamera-Fehler: '+e.message);
        }
      }
    }

    async function loadPlaces(){
      try{
        const res = await fetch('orte.json?v='+Date.now());
        places = await res.json();
        // Dropdown
        placeSelect.innerHTML = '<option value="">Ort w√§hlen‚Ä¶</option>';
        places.forEach((p,i)=>{
          const opt=document.createElement('option');
          opt.value=String(i);
          opt.textContent=p.name||('Ort '+(i+1));
          placeSelect.appendChild(opt);
        });
        initMap();
      }catch(e){
        log('‚ùå orte.json nicht geladen: '+e.message);
      }
    }

    // Dist helper
    function distKm(lat1,lng1,lat2,lng2){
      const R=6371, dLat=(lat2-lat1)*Math.PI/180, dLon=(lng2-lng1)*Math.PI/180;
      const a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
      return R*2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    // Bild/Audio anzeigen
    function showPlace(p){
      if(!p) return;
      imageOverlay.onload = ()=> imageOverlay.style.display='block';
      imageOverlay.onerror = ()=> log('‚ùå Bildfehler: '+p.image);
      imageOverlay.src = p.image + (p.image.includes('?')?'&':'?') + 'v=' + Date.now();
      infoTitle.textContent = p.name||'';
      infoText.textContent = p.text||'';
      if(p.audio){
        audioPlayer.src = p.audio + (p.audio.includes('?')?'&':'?') + 'v=' + Date.now();
        audioBtn.style.display='inline-block';
        audioBtn.textContent='‚ñ∂Ô∏è Audio abspielen';
        audioBtn.onclick=()=>{
          if(audioPlayer.paused){ audioPlayer.play(); audioBtn.textContent='‚è∏Ô∏è Pause'; }
          else { audioPlayer.pause(); audioBtn.textContent='‚ñ∂Ô∏è Audio abspielen'; }
        };
      } else {
        audioBtn.style.display='none';
      }
      infobox.style.display = (p.text||p.audio) ? 'block' : 'none';
    }

    // GPS-Autotrigger (nur wenn nicht manuell)
    function setupGPS(){
      if(!navigator.geolocation){ log('‚ùå Kein GPS'); return; }
      navigator.geolocation.watchPosition(pos=>{
        if(manualMode) return;
        const {latitude:lat, longitude:lng} = pos.coords;
        // N√§chsten Ort finden
        let best=null, bestKm=1e9;
        for(const p of places){
          const d = distKm(lat,lng,p.lat,p.lng);
          if(d<bestKm){bestKm=d; best=p;}
        }
        if(best){
          const rKm = ((best.radius ?? best.radius_m ?? 100)/1000);
          if(bestKm<=rKm) showPlace(best);
        }
      }, err=> log('‚ùå GPS: '+err.message), { enableHighAccuracy:true });
    }

    // Opacity control
    opacity.addEventListener('input', ()=> imageOverlay.style.opacity = opacity.value/100 );

    // Simple pan (Pointer Events)
    imageOverlay.style.touchAction='none';
    let dragging=false,last={x:0,y:0}, state={x:0,y:0,scale:1,rot:0};
    function apply(){ imageOverlay.style.transform = `translate(${state.x}px, ${state.y}px) scale(${state.scale}) rotate(${state.rot}deg)`; }
    imageOverlay.addEventListener('pointerdown', e=>{ if(e.target.closest('#footer')) return; dragging=true; last={x:e.clientX,y:e.clientY}; imageOverlay.setPointerCapture(e.pointerId); });
    imageOverlay.addEventListener('pointermove', e=>{ if(!dragging) return; const dx=e.clientX-last.x, dy=e.clientY-last.y; state.x+=dx; state.y+=dy; last={x:e.clientX,y:e.clientY}; apply(); });
    imageOverlay.addEventListener('pointerup', ()=> dragging=false);
    imageOverlay.addEventListener('pointercancel', ()=> dragging=false);

    // Map
    function initMap(){
      if(map){ setTimeout(()=>map.invalidateSize(),0); return; }
      map = L.map('map', { zoomControl: true });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19, attribution: '&copy; OpenStreetMap-Mitwirkende'
      }).on('tileerror', ()=> log('‚ùå Kacheln blockiert (Netz/Adblock/CSP?)')).addTo(map);

      // Default Sicht
      map.setView([47.049, 8.305], 13);

      const bounds=[];
      places.forEach((p,idx)=>{
        if(typeof p.lat!=='number'||typeof p.lng!=='number') return;
        const m=L.marker([p.lat,p.lng]).addTo(map);
        m.bindPopup(`<b>${p.name||('Ort '+(idx+1))}</b><br><button data-idx="${idx}" id="goto_${idx}">Ort anzeigen</button>`);
        m.on('click',()=>{
          m.openPopup();
          setTimeout(()=>{
            const btn=document.getElementById(`goto_${idx}`);
            if(btn){
              btn.addEventListener('click',()=>{
                placeSelect.value=String(idx);
                placeSelect.dispatchEvent(new Event('change'));
                toggleMap(false);
              });
            }
          },50);
        });
        bounds.push([p.lat,p.lng]);
      });
      if(bounds.length) map.fitBounds(bounds,{padding:[40,40]});
      else log('‚ÑπÔ∏è Keine Orte (Pins = 0)');
    }

    function toggleMap(force){
      mapVisible = (typeof force==='boolean') ? force : !mapVisible;
      mapWrap.style.display = mapVisible ? 'block' : 'none';
      camera.style.display = mapVisible ? 'none' : 'block';
      imageOverlay.style.display = mapVisible ? 'none' : imageOverlay.style.display;
      infobox.style.display = mapVisible ? 'none' : infobox.style.display;
      toggleMapBtn.textContent = mapVisible ? 'üì∑ Kamera' : 'üó∫Ô∏è Karte';
      if(mapVisible){ setTimeout(()=>{ initMap(); map.invalidateSize(); }, 0); }
    }
    toggleMapBtn.addEventListener('click', ()=> toggleMap());

    // Manual select
    placeSelect.addEventListener('change', ()=>{
      const idx = placeSelect.value ? parseInt(placeSelect.value,10) : NaN;
      if(!isNaN(idx) && places[idx]){
        manualMode = true;
        showPlace(places[idx]);
        backToGPS.style.display='inline-block';
        log('üìç Manuell: '+(places[idx].name||('Ort '+(idx+1))));
      }
    });
    backToGPS.addEventListener('click', ()=>{
      manualMode=false; backToGPS.style.display='none'; log('‚Ü©Ô∏è Zur√ºck zu GPS');
    });

    // Start
    startbtn.addEventListener('click', async ()=>{
      startscreen.style.display='none';
      header.style.display='flex';
      footer.style.display='block';
      await startCamera();
      await loadPlaces();
      setupGPS();
    });
  </script>
</body>
</html>
